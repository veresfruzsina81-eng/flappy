<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini Platformer ‚Äì Mario‚Äëszer≈±, hossz√∫ p√°lya + mozg√≥ platformok + f≈ëgonosz</title>
  <style>
    :root{
      --ink:#0f172a;--hud:#ffffffcc;--sky:#8fd3ff;--ground:#7c3aed;--platform:#c97436;
      --brick:#b65a2a;--brickDark:#9e4d22;--qblock:#f7b500;--qmark:#8a5400;
      --player:#ffd34a;--playerAcc:#ffb703;--enemy:#ef4444;--coin:#22c55e;--goal:#10b981;--boss:#9333ea;
      --pipe:#16a34a;--checkpoint:#60a5fa;--star:#facc15;--spring:#dc2626
    }
    html,body{height:100%;margin:0;background:var(--sky);font-family:system-ui,Segoe UI,Inter,Roboto,Arial,sans-serif;color:var(--ink)}
    .wrap{display:grid;place-items:center;height:100%}
    canvas{display:block;max-width:96vw;max-height:86vh;border-radius:16px;box-shadow:0 20px 70px rgba(2,6,23,.25);background:linear-gradient(180deg,#b3e5ff,#e6f3ff)}
    .hud{position:fixed;top:10px;left:50%;transform:translateX(-50%);display:flex;gap:16px;padding:8px 12px;background:var(--hud);border-radius:12px;font-weight:800}
    .btnbar{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);display:flex;gap:10px}
    button{border:0;border-radius:12px;padding:10px 14px;background:#ffffffcc;backdrop-filter:blur(6px);font-weight:700;cursor:pointer}
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,.5)}
    .card{background:white;padding:20px 24px;border-radius:16px;text-align:center;box-shadow:0 12px 40px rgba(0,0,0,.25)}
    .card h1{margin:6px 0 8px}
    .muted{color:#475569}
    .kbd{font-family:ui-monospace,Consolas,monospace;background:#e2e8f0;border-radius:8px;padding:2px 6px;margin:0 2px;display:inline-block}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hud">√âlet: <span id="lives">3</span> ‚Ä¢ Pont: <span id="score">0</span> ‚Ä¢ Id≈ë: <span id="time">0</span>s ‚Ä¢ Sz√©rum: <span id="serum">‚úñ</span> ‚Ä¢ Csillag: <span id="star">‚úñ</span> ‚Ä¢ <span id="vol">üîä</span></div>
    <canvas id="game" width="960" height="540" aria-label="Mini platformer"></canvas>
    <div class="btnbar"><button id="restart">√öjra</button><button id="pause">Sz√ºnet</button></div>
  </div>
  <div class="overlay" id="over">
    <div class="card">
      <h1 id="title">V√©ge</h1>
      <p class="muted" id="desc"></p>
      <p class="muted">Ir√°ny√≠t√°s: <span class="kbd">A</span>/<span class="kbd">D</span> vagy <span class="kbd">‚Üê</span>/<span class="kbd">‚Üí</span> ‚Äì mozg√°s, <span class="kbd">Space</span> ‚Äì ugr√°s, <span class="kbd">J</span> ‚Äì l√∂v√©s (ha van sz√©rum), <span class="kbd">M</span> ‚Äì hang n√©m√≠t√°s</p>
      <button id="again">√öjra</button>
    </div>
  </div>

  <script>
  // ===== Canvas & HiDPI =====
  const cvs=document.getElementById('game'); const ctx=cvs.getContext('2d');
  function fitHiDPI(){const ratio=Math.max(1,Math.floor(window.devicePixelRatio||1)); const cssW=cvs.clientWidth||cvs.width, cssH=cvs.clientHeight||cvs.height; cvs.width=cssW*ratio; cvs.height=cssH*ratio; ctx.setTransform(ratio,0,0,ratio,0,0);} fitHiDPI(); addEventListener('resize',fitHiDPI);

  // ===== HUD =====
  const livesEl=document.getElementById('lives'); const scoreEl=document.getElementById('score'); const timeEl=document.getElementById('time'); const serumEl=document.getElementById('serum'); const starEl=document.getElementById('star'); const volEl=document.getElementById('vol');

  // ===== AUDIO (WebAudio) =====
  let AC; let musicOn=false; let muted=false; function ac(){ if(!AC){ AC=new (window.AudioContext||window.webkitAudioContext)(); } return AC; }
  function out(){ const a=ac(); if(!out.node){ out.node=a.createGain(); out.node.gain.value=0.12; out.node.connect(a.destination);} return out.node; }
  function sfx(freq=440, dur=0.08, type='square', vol=0.2){ if(muted) return; const a=ac(); const o=a.createOscillator(); const g=a.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=vol; o.connect(g).connect(out()); o.start(); o.stop(a.currentTime+dur); }
  function sfxSweep(f1=800,f2=200,dur=0.25,type='sawtooth',vol=0.2){ if(muted) return; const a=ac(); const o=a.createOscillator(); const g=a.createGain(); o.type=type; o.frequency.setValueAtTime(f1,a.currentTime); o.frequency.exponentialRampToValueAtTime(f2,a.currentTime+dur); g.gain.value=vol; o.connect(g).connect(out()); o.start(); o.stop(a.currentTime+dur); }
  function startMusic(){ if(musicOn||muted) return; const a=ac(); const master=a.createGain(); master.gain.value=0.05; master.connect(out()); const notes=[262,330,392,523,392,330]; let i=0; function tick(){ const o=a.createOscillator(); const g=a.createGain(); o.type='triangle'; o.frequency.value=notes[i%notes.length]; g.gain.setValueAtTime(0.0001,a.currentTime); g.gain.exponentialRampToValueAtTime(0.06,a.currentTime+0.02); g.gain.exponentialRampToValueAtTime(0.0001,a.currentTime+0.38); o.connect(g).connect(master); o.start(); o.stop(a.currentTime+0.4); i++; if(musicOn && !muted) setTimeout(tick,420);} musicOn=true; tick(); }
  function stopMusic(){ musicOn=false; if(AC){ AC.close(); AC=null; out.node=null; } }

  // ===== Fizika & vil√°g =====
  const G=0.9, FRICTION=0.82, MOVE_ACC=0.85, MAX_VX=4.4, JUMP_V=-15;
  const W=960, H=540; const floorY=H-60; const LEVEL_W=3200; // m√©g hosszabb p√°lya
  let camX=0; let t=0, running=true;

  // ===== J√°t√©kos =====
  const player={x:80,y:floorY-48,w:26,h:40,vx:0,vy:0,onGround:false,faces:1,lives:3,score:0, animTimer:0, frame:0, state:'idle', canShoot:false, lastShot:0, respawnX:80, respawnY:floorY-48, star:0};

  // ===== P√°lyaelemek =====
  function seg(x,y,w,h){return{x,y,w,h,type:'ground'}}; function brick(x,y,w,h){return{x,y,w,h,type:'brick'}}
  const platforms=[ seg(0,floorY,420,60), seg(520,floorY,260,60), seg(860,floorY,380,60), seg(1300,floorY,340,60), seg(1720,floorY,260,60), seg(2060,floorY,540,60), seg(2620,floorY,520,60),
                    brick(220,floorY-110,140,16), brick(440,floorY-170,120,16), brick(740,floorY-160,120,16), brick(980,floorY-200,140,16), brick(1260,floorY-140,120,16), brick(1500,floorY-190,140,16), brick(1840,floorY-160,120,16), brick(2140,floorY-220,160,16), brick(2460,floorY-160,120,16), brick(2860,floorY-200,160,16)];

  // Mozg√≥ platformok
  const movers=[ {x:620,y:floorY-140,w:90,h:16,type:'brick',minX:600,maxX:820,speed:1.6,dir:1}, {x:2000,y:floorY-160,w:110,h:16,type:'brick',minY:floorY-240,maxY:floorY-140,speed:1.2,dir:1,vertical:true} ];

  // Rug√≥ (spring)
  const springs=[ {x:1180,y:floorY-20,w:24,h:20,power:-20} ];

  // Cs√∂vek (pipe) piranha-sz√∂rnyekkel
  const pipes=[ {x:1050,y:floorY-60,w:44,h:60,t:0,up:false}, {x:2380,y:floorY-80,w:44,h:80,t:0,up:false} ];

  // Question blockok + √©rm√©k + sz√©rum + csillag (invincibility)
  const qblocks=[ {x:480,y:floorY-170-20,w:20,h:20,hit:false}, {x:760,y:floorY-160-20,w:20,h:20,hit:false}, {x:1520,y:floorY-190-20,w:20,h:20,hit:false} ];
  const coins=[ {x:460,y:floorY-170-28,w:14,h:14}, {x:820,y:floorY-160-28,w:14,h:14}, {x:1300,y:floorY-140-28,w:14,h:14}, {x:1880,y:floorY-160-28,w:14,h:14}, {x:2680,y:floorY-20-28,w:14,h:14} ];
  const serum={x:1120,y:floorY-120-24,w:16,h:24, picked:false};
  const starPick={x:2550,y:floorY-100-16,w:16,h:16,picked:false};

  // Ellens√©gek
  function makeEnemy(x,y,w,h,minX,maxX,speed){return{ x,y,w,h,minX,maxX,speed,vx:speed,vy:0,onGround:false,active:true, dir:1}};
  const enemies=[ makeEnemy(300,floorY-20,22,20,260,400,1.4), makeEnemy(900,floorY-20,22,20,860,1240,1.2), makeEnemy(460,floorY-170-20,20,20,440,560,1.1), makeEnemy(1000,floorY-200-20,20,20,980,1120,1.1), makeEnemy(2140,floorY-220-20,22,22,2140,2300,1.3), makeEnemy(2700,floorY-20,22,20,2620,3000,1.4) ];

  // Checkpoint z√°szl√≥k
  const checkpoints=[ {x:1400,y:floorY-150}, {x:2300,y:floorY-150} ];

  // F≈ëgonosz
  const boss={x:LEVEL_W-320,y:floorY-60-40,w:40,h:40,hp:14,alive:true,shotCd:0};
  const bossBullets=[]; const bullets=[]; // j√°t√©kos l√∂ved√©kek

  // C√©l
  const goal={x:LEVEL_W-60,y:floorY-180,w:8,h:180};

  // ===== Ir√°ny√≠t√°s =====
  const keys={left:false,right:false,jump:false,shoot:false};
  addEventListener('keydown',e=>{ if(['ArrowLeft','KeyA'].includes(e.code))keys.left=true; if(['ArrowRight','KeyD'].includes(e.code))keys.right=true; if(e.code==='Space'){e.preventDefault(); keys.jump=true;} if(e.code==='KeyJ'){ keys.shoot=true; } if(e.code==='KeyM'){ muted=!muted; volEl.textContent=muted?'üîá':'üîä'; if(muted) stopMusic(); } startMusic(); });
  addEventListener('keyup',e=>{ if(['ArrowLeft','KeyA'].includes(e.code))keys.left=false; if(['ArrowRight','KeyD'].includes(e.code))keys.right=false; if(e.code==='Space')keys.jump=false; if(e.code==='KeyJ')keys.shoot=false; });
  document.getElementById('restart').onclick=()=>reset();
  document.getElementById('pause').onclick=()=>{ running=!running; if(running) loop(); else stopMusic(); };
  document.getElementById('again').onclick=()=>{hideOverlay(); reset();};

  // ===== Util =====
  function getVar(name){return getComputedStyle(document.documentElement).getPropertyValue(name).trim();}
  function showOverlay(title,desc){document.getElementById('title').textContent=title; document.getElementById('desc').textContent=desc; document.getElementById('over').style.display='flex';}
  function hideOverlay(){document.getElementById('over').style.display='none';}
  function aabb(a,b){return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y}
  function clamp(v,min,max){return Math.max(min,Math.min(max,v));}

  function solids(){ return [ ...platforms, ...qblocks, ...movers ]; }
  // --- √öj seg√©df√ºggv√©nyek a stabilabb fizik√°hoz ---
  function isSolidAt(x,y){
    for(const p of solids()){
      if(x>=p.x && x<=p.x+p.w && y>=p.y && y<=p.y+p.h) return true;
    }
    return false;
  }
  function onTopOf(a,b){
    // akkor igaz, ha A a B tetej√©n √°ll (kis toleranci√°val) √©s v√≠zszintesen fedik egym√°st
    const horiz = a.x + a.w > b.x && a.x < b.x + b.w;
    const feet = Math.abs((a.y + a.h) - b.y) <= 3; // 3px tolerancia
    return horiz && feet;
  }

  // ===== Reset =====
  function reset(){
    Object.assign(player,{x:player.respawnX,y:player.respawnY,vx:0,vy:0,onGround:false,lives:3,score:0,animTimer:0,frame:0,state:'idle',canShoot:false,star:0});
    // input √°llapotok biztos null√°z√°sa
    keys.left=keys.right=keys.jump=keys.shoot=false;
    bullets.length=0; bossBullets.length=0;
    boss.x=LEVEL_W-320; boss.y=floorY-60-40; boss.hp=14; boss.alive=true; boss.shotCd=0;
    serum.picked=false; starPick.picked=false; qblocks.forEach(b=>b.hit=false);
    t=0; running=true; camX=0; hideOverlay(); loop();
  }

  // ===== Mozgat√°s & √ºtk√∂z√©s =====
  function moveAndCollide(o,isEnemy=false){ // X
    o.x+=o.vx||0; for(const p of solids()){ if(rectOverlap(o,p)){ if(o.vx>0) o.x=p.x-o.w; else if(o.vx<0) o.x=p.x+p.w; o.vx=0; }}
    // Y
    o.y+=o.vy||0; let onG=false; for(const p of solids()){ if(rectOverlap(o,p)){ if((o.vy||0)>0){ o.y=p.y-o.h; onG=true; } else if((o.vy||0)<0){ o.y=p.y+p.h; } o.vy=0; }} if(!isEnemy && o===player) o.onGround=onG;
  }
  function rectOverlap(a,b){return aabb(a,b)}

  // ===== Update =====
  function update(){ t+=1/60; timeEl.textContent=t.toFixed(0); livesEl.textContent=player.lives; scoreEl.textContent=player.score; serumEl.textContent=player.canShoot?'‚úî':'‚úñ'; starEl.textContent=player.star>0?'‚úî':'‚úñ'; if(player.star>0) player.star-=1;
    // Player input
    if(keys.left) player.vx-=MOVE_ACC; if(keys.right) player.vx+=MOVE_ACC; player.vx*=FRICTION; player.vx=clamp(player.vx,-MAX_VX,MAX_VX);
    if(keys.jump && player.onGround){ player.vy=JUMP_V; player.onGround=false; sfx(700,0.08,'square',0.2); }
    player.vy+=G; if(player.vy>20) player.vy=20;

    // L√∂v√©s
    if(keys.shoot && player.canShoot && (performance.now()-player.lastShot>220)){ shoot(); }

    // Anim √°llapot
    if(!player.onGround) player.state='jump'; else if(Math.abs(player.vx)>0.5) player.state='run'; else player.state='idle';
    player.animTimer += (player.state==='run'? 1 : 0.5); if(player.animTimer>8){ player.animTimer=0; player.frame=(player.frame+1)%2; }

    // Mozg√≥ platformok anim√°l√°sa
    for(const m of movers){
      if(m.vertical){
        m.y += m.speed*m.dir;
        if(m.y < m.maxY){ m.y = m.maxY; m.dir = 1; }
        if(m.y > m.minY){ m.y = m.minY; m.dir = -1; }
      } else {
        m.x += m.speed*m.dir;
        if(m.x < m.minX){ m.x = m.minX; m.dir = 1; }
        if(m.x + m.w > m.maxX){ m.x = m.maxX - m.w; m.dir = -1; }
      }
      // Csak akkor vigyen mag√°val, ha t√©nyleg a tetej√©n √°llunk
      if(onTopOf(player, m)){
        player.x += (m.vertical ? 0 : m.speed*m.dir);
      }
    }

    moveAndCollide(player);

    // Kamera
    camX = clamp(player.x - W*0.4, 0, LEVEL_W - W);

    // Rug√≥
    for(const s of springs){ if(aabb(player,s) && player.vy>=0){ player.vy = s.power; sfx(900,0.07,'triangle',0.25); }}

    // Pipes piranha mozg√°s (fel-le)
    for(const p of pipes){ p.t++; const cycle=180; const up = (p.t%cycle)>60 && (p.t%cycle)<140; p.up=up; }
    // piranha sebz√©s ha fel√ºl van √©s hozz√°√©rsz a ny√≠l√°sn√°l
    for(const p of pipes){ if(p.up){ const head={x:p.x+8,y:p.y-24,w:p.w-16,h:24}; if(aabb(player,head) && player.star<=0){ loseLife(); }}}

    // Enemies
    for(const e of enemies){
      if(!e.active) continue;
      // gravit√°ci√≥ csak a f√∂ldiekre
      if(e.type !== 'fly'){
        e.vy += G; if(e.vy>20) e.vy=20;
      }
      if(e.type === 'patrol'){
        // el≈ërel√°t√≥ peremv√©delem: ne l√©pjen le a sz√©l√©r≈ël
        const aheadX = e.x + (e.dir>0 ? e.w+1 : -1);
        const footY = e.y + e.h + 1;
        if(!isSolidAt(aheadX, footY)) e.dir *= -1;
        // mozg√°s √©s hat√°rok
        e.x += e.speed * e.dir;
        if(e.x < e.minX){ e.x = e.minX; e.dir = 1; }
        if(e.x + e.w > e.maxX){ e.x = e.maxX - e.w; e.dir = -1; }
        moveAndCollide(e, true);
      } else if(e.type === 'fly'){
        e.x += e.speed * (e.dir||1);
        if(e.x < e.minX){ e.x = e.minX; e.dir = 1; }
        if(e.x + e.w > e.maxX){ e.x = e.maxX - e.w; e.dir = -1; }
        e.t = (e.t||0) + 0.08; e.y += Math.sin(e.t) * 0.9;
      } else if(e.type === 'fall'){
        e.vy += 0.35; e.y += e.vy; if(e.y>H+80) e.active=false;
      }
      if(Math.random()<0.002 && !muted) sfx(220,0.04,'square',0.05);
    }

    // Coins
    for(let i=coins.length-1;i>=0;i--){const c=coins[i]; if(aabb(player,c)){ coins.splice(i,1); player.score+=5; sfx(900,0.07,'triangle',0.2); }}

    // Question blocks ‚Äì alulr√≥l fejjel
    for(const b of qblocks){ if(aabb(player,b) && player.vy<0 && player.y> b.y+b.h-8){ if(!b.hit){ player.score+=2; sfx(500,0.06,'square',0.15);} b.hit=true; player.vy=2; }}

    // Sz√©rum & Csillag
    if(!serum.picked && aabb(player,serum)){ serum.picked=true; player.canShoot=true; player.score+=8; sfxSweep(1200,400,0.25,'sawtooth',0.2); }
    if(!starPick.picked && aabb(player,starPick)){ starPick.picked=true; player.star=60*8; sfxSweep(400,1600,0.6,'triangle',0.25); }

    // J√°t√©kos vs ellens√©g
    for(const e of enemies){ if(!e.active) continue; if(aabb(player,e)){
      if(player.vy>0 && player.y+player.h<=e.y+8){ e.active=false; player.vy=JUMP_V*0.6; player.score+=10; sfxSweep(800,200,0.2,'square',0.18); }
      else { if(player.star>0){ e.active=false; player.score+=10; } else { loseLife(); break; } }
    }}

    // L√∂ved√©kek ‚Äì j√°t√©kos
    for(let i=bullets.length-1;i>=0;i--){ const b=bullets[i]; b.x += b.vx; for(const e of enemies){ if(e.active && aabb(b,e)){ e.active=false; bullets.splice(i,1); player.score+=10; sfx(300,0.07,'triangle',0.2); break; }} if(boss.alive && aabb(b,boss)){ boss.hp--; bullets.splice(i,1); sfx(180,0.06,'square',0.2); if(boss.hp<=0){ boss.alive=false; player.score+=50; sfxSweep(600,80,0.5,'sawtooth',0.25);} } if(b.x<0 || b.x>LEVEL_W) bullets.splice(i,1); }

    // Boss AI
    if(boss.alive){ boss.shotCd-=1; if(boss.shotCd<=0){ bossShoot(); boss.shotCd=80; } }
    for(let i=bossBullets.length-1;i>=0;i--){ const b=bossBullets[i]; b.x+=b.vx; b.y+=b.vy; if(aabb(player,b) && player.star<=0){ bossBullets.splice(i,1); loseLife(); } if(b.x<0||b.x>LEVEL_W||b.y>H+200) bossBullets.splice(i,1); }

    // Lees√©s
    if(player.y>H+80){ loseLife(); }

    // Checkpoint
    for(const c of checkpoints){ if(aabb(player,{x:c.x-6,y:c.y-40,w:12,h:80})){ player.respawnX=c.x; player.respawnY=c.y; }}

    // C√©l (csak ha a boss halott)
    if(aabb(player,{x:goal.x-6,y:goal.y,w:goal.w+12,h:goal.h}) && (!boss.alive)){ running=false; showOverlay('Nyert√©l! üèÅ', `Pont: ${player.score} ‚Ä¢ Id≈ë: ${timeEl.textContent}s`); }
  }

  function shoot(){ const dir = player.faces; const speed=8; const bx=player.x + (dir>0? player.w : -6); const by=player.y+player.h*0.35; bullets.push({x:bx,y:by,w:8,h:4,vx:speed*dir}); player.lastShot=performance.now(); sfx(1000,0.05,'square',0.2); }
  function bossShoot(){ const dx=(player.x - boss.x), dy=(player.y - boss.y); const len=Math.max(1,Math.hypot(dx,dy)); const sp=4.2; bossBullets.push({x:boss.x+boss.w/2,y:boss.y+boss.h/2,w:6,h:6,vx:sp*dx/len,vy:sp*dy/len}); sfx(240,0.08,'sawtooth',0.15); }

  function loseLife(){ if(player.star>0) return; sfxSweep(400,120,0.25,'triangle',0.25); player.lives--; if(player.lives>0){ Object.assign(player,{x:player.respawnX,y:player.respawnY,vx:0,vy:0,onGround:false}); camX = clamp(player.x - W*0.4, 0, LEVEL_W-W); } else { running=false; stopMusic(); showOverlay('Vesztett√©l üíÄ', `Pont: ${player.score} ‚Ä¢ Id≈ë: ${timeEl.textContent}s`);} }

  // ===== Rajzol√°s =====
  function draw(){ ctx.clearRect(0,0,W,H); drawBackDecor();
    // Ground + platformok
    platforms.forEach(p=> drawPlatform(p)); movers.forEach(p=> drawPlatform(p));
    qblocks.forEach(b=> drawQBlock(b)); coins.forEach(c=> drawRect(c.x,c.y,c.w,c.h,getVar('--coin'),4));

    // Rug√≥
    springs.forEach(s=> drawRect(s.x,s.y,s.w,s.h,getVar('--spring'),4));

    // Pipes
    pipes.forEach(p=> drawPipe(p));

    // Powerups
    if(!serum.picked) drawSerum(serum); if(!starPick.picked) drawStar(starPick);

    // Boss + l√∂ved√©kek
    if(boss.alive) drawBoss(boss); bossBullets.forEach(b=> drawRect(b.x,b.y,b.w,b.h,'#222',2));

    // Enemies
    enemies.forEach(e=>{ if(e.active) drawEnemy(e); });

    // Player l√∂ved√©kek
    bullets.forEach(b=> drawRect(b.x,b.y,b.w,b.h,'#333',2));

    // Checkpoint z√°szl√≥k
    checkpoints.forEach(c=> drawCheckpoint(c));

    // C√©l
    drawFlagpole();

    // Player
    drawPlayer();
  }

  function toCam(x){ return Math.round(x - camX); }
  function drawRect(x,y,w,h,fill,r=0){ ctx.save(); ctx.translate(toCam(x),y); roundRect(0,0,w,h,r); ctx.fillStyle=fill; ctx.fill(); ctx.restore(); }
  function drawPlatform(p){ if(p.type==='ground'){ ctx.fillStyle=getVar('--ground'); ctx.fillRect(toCam(p.x), p.y, p.w, p.h); } else { ctx.save(); ctx.translate(toCam(p.x), p.y); const bw=20, bh=10; for(let yy=0; yy<p.h; yy+=bh){ for(let xx=0; xx<p.w; xx+=bw){ ctx.fillStyle=getVar('--brick'); ctx.fillRect(xx,yy,bw-1,bh-1); ctx.fillStyle=getVar('--brickDark'); ctx.fillRect(xx,yy+bh-3,bw-1,3); }} ctx.restore(); } }
  function drawQBlock(b){ ctx.save(); ctx.translate(toCam(b.x),b.y); ctx.fillStyle=getVar('--qblock'); roundRect(0,0,b.w,b.h,3); ctx.fill(); ctx.fillStyle='rgba(0,0,0,.25)'; roundRect(0,0,b.w,b.h,3); ctx.stroke(); ctx.fillStyle=getVar('--qmark'); ctx.fillRect(7,4,3,3); ctx.fillRect(11,4,3,3); ctx.fillRect(7,8,3,3); ctx.fillRect(11,8,3,3); ctx.fillRect(9,12,3,3); if(b.hit){ ctx.fillStyle='rgba(255,255,255,.6)'; ctx.fillRect(0,-3,b.w,b.h); } ctx.restore(); }
  function drawPipe(p){ const x=toCam(p.x); ctx.fillStyle=getVar('--pipe'); roundRect(x,p.y-p.h,p.w,p.h,6); ctx.fill(); ctx.fillStyle='#fff'; roundRect(x-4,p.y-p.h-12,p.w+8,14,6); ctx.fill(); if(p.up){ ctx.fillStyle='#14532d'; roundRect(x+8,p.y-p.h-24,p.w-16,24,4); ctx.fill(); } }
  function drawSerum(s){ drawRect(s.x,s.y,s.w,s.h,'#14b8a6',3); }
  function drawStar(s){ ctx.save(); ctx.translate(toCam(s.x),s.y); ctx.fillStyle=getVar('--star'); roundRect(0,0,s.w,s.h,3); ctx.fill(); ctx.fillStyle='#a16207'; ctx.fillRect(4,4,s.w-8,s.h-8); ctx.restore(); }
  function drawEnemy(e){ ctx.save(); ctx.translate(toCam(e.x),e.y); ctx.fillStyle=getVar('--enemy'); roundRect(0,0,e.w,e.h,4); ctx.fill(); ctx.fillStyle='#111'; ctx.fillRect(e.w*0.65,3,3,3); ctx.fillStyle='#a11'; ctx.fillRect(3,e.h-3,6,3); ctx.fillRect(e.w-9,e.h-3,6,3); ctx.restore(); }
  function drawBoss(b){ ctx.save(); ctx.translate(toCam(b.x),b.y); ctx.fillStyle=getVar('--boss'); roundRect(0,0,b.w,b.h,6); ctx.fill(); const pct=Math.max(0,b.hp/14); ctx.fillStyle='#111'; ctx.fillRect(0,-8,b.w,4); ctx.fillStyle='#22c55e'; ctx.fillRect(0,-8,b.w*pct,4); ctx.restore(); }
  function drawCheckpoint(c){ const x=toCam(c.x); ctx.fillStyle='#d1d5db'; ctx.fillRect(x-2, c.y-80, 4, 80); ctx.fillStyle=getVar('--checkpoint'); ctx.beginPath(); ctx.moveTo(x, c.y-60); ctx.lineTo(x+22, c.y-66); ctx.lineTo(x+22, c.y-54); ctx.closePath(); ctx.fill(); }
  function drawPlayer(){ ctx.save(); ctx.translate(toCam(player.x)+player.w/2, player.y+player.h/2); ctx.scale(player.faces,1); ctx.fillStyle= player.star>0 ? '#fde047' : getVar('--player'); roundRect(-10,-18,20,36,6); ctx.fill(); ctx.fillStyle='#ffe08a'; roundRect(-9,-30,18,14,4); ctx.fill(); ctx.fillStyle='#111'; ctx.fillRect(2,-26,3,3); const runPhase = player.state==='run' ? player.frame : 0; ctx.fillStyle=getVar('--playerAcc'); if(player.state==='jump'){ ctx.fillRect(-9,12,6,10); ctx.fillRect(3,12,6,10);} else if(runPhase===0){ ctx.fillRect(-12,12,8,10); ctx.fillRect(4,12,8,10);} else { ctx.fillRect(-6,12,8,10); ctx.fillRect(-14,12,8,10);} ctx.restore(); }
  function drawFlagpole(){ const x=toCam(goal.x); ctx.fillStyle='#d1d5db'; ctx.fillRect(x, goal.y, goal.w, goal.h); ctx.fillStyle='#9ca3af'; ctx.beginPath(); ctx.arc(x+goal.w/2, goal.y, 6, 0, Math.PI*2); ctx.fill(); const wave = Math.sin(performance.now()/240)*3; ctx.fillStyle=getVar('--goal'); ctx.beginPath(); ctx.moveTo(x+goal.w, goal.y+20); ctx.lineTo(x+goal.w+28, goal.y+16+wave); ctx.lineTo(x+goal.w+28, goal.y+28-wave); ctx.closePath(); ctx.fill(); }
  function roundRect(x,y,w,h,r){const rr=Math.min(r,Math.abs(w)/2,Math.abs(h)/2); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath();}

  function loop(){ if(!running) return; update(); draw(); requestAnimationFrame(loop); }

  // ===== Start =====
  reset();
  </script>
</body>
</html>
