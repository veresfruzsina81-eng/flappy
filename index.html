<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AI Pet ‚Ä¢ Tam√°s edition</title>
<style>
:root{--bg:#f3f7ff;--ink:#0f172a;--card:#fff;--ui:#111827;--acc:#6ee7b7;--warn:#f59e0b;--ok:#22c55e;--bad:#ef4444}
*{box-sizing:border-box} html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:linear-gradient(180deg,#eaf3ff,#fafdff)}
.wrap{max-width:980px;margin:24px auto;padding:0 16px}
.grid{display:grid;grid-template-columns:1.1fr 1fr;gap:16px}
.card{background:var(--card);border-radius:16px;box-shadow:0 10px 40px rgba(2,6,23,.08);padding:16px}
h1{font-size:22px;margin:0 0 8px}
small.mono{font-family:ui-monospace,Consolas,monospace;opacity:.7}
canvas{width:100%;height:420px;display:block;border-radius:14px;background:linear-gradient(180deg,#c3e4ff,#ffffff)}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:12px 0}
.bar{background:#eef2ff;border-radius:10px;overflow:hidden;height:10px}
.fill{height:100%;background:linear-gradient(90deg,#60a5fa,#22c55e)}
.buttons{display:flex;flex-wrap:wrap;gap:8px}
button{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;background:#eef2ff}
button.primary{background:#dbeafe}
button:active{transform:translateY(1px)}
.hud{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.hud input[type=range]{width:140px}
.chat{display:flex;flex-direction:column;gap:8px;height:520px}
.chatlog{flex:1;overflow:auto;background:#f6f7fb;border-radius:12px;padding:12px}
.msg{margin-bottom:10px}
.msg.me{ text-align:right}
.bubble{display:inline-block;padding:10px 12px;border-radius:12px;max-width:80%}
.me .bubble{background:#dbeafe}
.ai .bubble{background:#e9ffef}
input[type=text]{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px}
.kbd{font-family:ui-monospace,Consolas,monospace;background:#eef2ff;border-radius:8px;padding:2px 6px}
footer{margin-top:8px;opacity:.7;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="hud">
    <h1 style="margin-right:auto">AI Pet ‚Ä¢ <span id="petName">Kipi</span></h1>
    <label>Hanger≈ë <input id="vol" type="range" min="0" max="1" step="0.01" value="0.35"></label>
    <button id="rename">N√©v csere</button>
  </div>

  <div class="grid">
    <!-- Bal: j√°t√©k -->
    <div class="card">
      <canvas id="cvs" width="920" height="420" aria-label="AI Pet v√°szon"></canvas>

      <div class="stats">
        <div><div style="display:flex;justify-content:space-between"><small>√âhs√©g</small><small id="hungerV">50</small></div><div class="bar"><div id="hunger" class="fill" style="width:50%"></div></div></div>
        <div><div style="display:flex;justify-content:space-between"><small>Energia</small><small id="energyV">50</small></div><div class="bar"><div id="energy" class="fill" style="width:50%"></div></div></div>
        <div><div style="display:flex;justify-content:space-between"><small>Tisztas√°g</small><small id="cleanV">50</small></div><div class="bar"><div id="clean" class="fill" style="width:50%"></div></div></div>
        <div><div style="display:flex;justify-content:space-between"><small>Boldogs√°g</small><small id="happyV">50</small></div><div class="bar"><div id="happy" class="fill" style="width:50%"></div></div></div>
      </div>

      <div class="buttons">
        <button id="feed" class="primary">üçΩÔ∏è Etet√©s</button>
        <button id="wash">ü´ß F√ºrdet√©s</button>
        <button id="sleep">üò¥ Alv√°s</button>
        <button id="play">üéà J√°t√©k</button>
        <button id="save">üíæ Ment√©s</button>
        <button id="reset">‚ôªÔ∏è Reset</button>
        <small class="mono">Tipp: <span class="kbd">F</span>=Etet√©s, <span class="kbd">W</span>=F√ºrd√©s, <span class="kbd">S</span>=Alv√°s, <span class="kbd">P</span>=J√°t√©k</small>
      </div>
    </div>

    <!-- Jobb: AI chat -->
    <div class="card chat">
      <div class="chatlog" id="log"></div>
      <div style="display:flex;gap:8px">
        <input type="text" id="input" placeholder="√çrj Kipi-nek‚Ä¶ (pl.: Mit szeretn√©l j√°tszani?)">
        <button id="send">K√ºld√©s</button>
      </div>
      <footer>Az AI-v√°laszokat egy **saj√°t proxy** h√≠vja (ne tedd az API-kulcsot a kliensbe!). Endpoint: <code>/api/chat</code></footer>
    </div>
  </div>
</div>

<script>
/* ======= √Ållapot ======= */
const state = JSON.parse(localStorage.getItem('pet-state')||'{}');
const pet = {
  name: state.name || 'Kipi',
  hunger: state.hunger ?? 50,   // 0 j√≥llakott ‚Üí 100 nagyon √©hes
  energy: state.energy ?? 50,
  clean:  state.clean  ?? 50,
  happy:  state.happy  ?? 50,
  mood: 'neutral'
};
const saveState=()=>localStorage.setItem('pet-state', JSON.stringify(pet));

/* ======= V√°szon & hang ======= */
const cvs=document.getElementById('cvs'), ctx=cvs.getContext('2d');
const vol=document.getElementById('vol');
const AC=window.AudioContext?new AudioContext():null;
const master=AC?AC.createGain():null; if(master){master.connect(AC.destination); master.gain.value=+vol.value}
vol.oninput=()=>{if(master) master.gain.value=+vol.value};
function beep(f=600,d=0.08,type='sine',g=0.12){ if(!AC) return; const t=AC.currentTime; const o=AC.createOscillator(), a=AC.createGain(); o.type=type; o.frequency.value=f; a.gain.value=g; o.connect(a).connect(master); o.start(); o.stop(t+d); }

/* ======= UI k√∂t√©s ======= */
const $ = id => document.getElementById(id);
$('petName').textContent = pet.name;
$('rename').onclick=()=>{const n=prompt('Mi legyen a neve?', pet.name); if(n){pet.name=n; $('petName').textContent=pet.name; saveState();}}
const bars = { hunger:$('hunger'), energy:$('energy'), clean:$('clean'), happy:$('happy'),
               hungerV:$('hungerV'), energyV:$('energyV'), cleanV:$('cleanV'), happyV:$('happyV') };

function clamp(v,a=0,b=100){ return Math.max(a,Math.min(b,v)); }
function applyDecay(){
  pet.hunger = clamp(pet.hunger + 0.03);
  pet.energy = clamp(pet.energy - 0.02);
  pet.clean  = clamp(pet.clean  - 0.015);
  // boldogs√°g kont√≥: rossz √°llapotban cs√∂kken
  const penalty = (pet.hunger>70?0.05:0) + (pet.energy<30?0.05:0) + (pet.clean<30?0.05:0);
  pet.happy = clamp(pet.happy + 0.015 - penalty);
}
function setMood(){
  if(pet.happy>70 && pet.hunger<50 && pet.clean>50) pet.mood='happy';
  else if(pet.hunger>80 || pet.clean<25) pet.mood='sad';
  else if(pet.energy<25) pet.mood='sleepy';
  else pet.mood='neutral';
}
function refreshBars(){
  bars.hunger.style.width=pet.hunger+'%';    bars.hungerV.textContent=pet.hunger|0;
  bars.energy.style.width=pet.energy+'%';    bars.energyV.textContent=pet.energy|0;
  bars.clean .style.width=pet.clean+'%';     bars.cleanV .textContent=pet.clean|0;
  bars.happy .style.width=pet.happy+'%';     bars.happyV .textContent=pet.happy|0;
}

/* ======= Akci√≥k ======= */
function act(type){
  if(type==='feed'){ pet.hunger=clamp(pet.hunger-25); pet.happy=clamp(pet.happy+8); beep(520,.09,'triangle')}
  if(type==='wash'){ pet.clean =clamp(pet.clean +30); pet.happy=clamp(pet.happy+5); beep(900,.08,'sine')}
  if(type==='sleep'){ pet.energy=clamp(pet.energy+40); pet.hunger=clamp(pet.hunger+10); beep(300,.12,'sine')}
  if(type==='play'){  pet.happy =clamp(pet.happy +20); pet.energy=clamp(pet.energy-10); beep(740,.08,'square')}
  setMood(); saveState(); refreshBars(); flash(type);
}
$('feed').onclick = ()=>act('feed');
$('wash').onclick = ()=>act('wash');
$('sleep').onclick= ()=>act('sleep');
$('play').onclick = ()=>act('play');
$('save').onclick = ()=>{saveState(); alert('Elmentve ‚úÖ')};
$('reset').onclick= ()=>{localStorage.removeItem('pet-state'); location.reload()};

// gyorsbillenty≈±k
addEventListener('keydown',e=>{
  if(e.repeat) return;
  if(e.key.toLowerCase()==='f') act('feed');
  if(e.key.toLowerCase()==='w') act('wash');
  if(e.key.toLowerCase()==='s') act('sleep');
  if(e.key.toLowerCase()==='p') act('play');
});

/* ======= Anim√°ci√≥ ======= */
let t=0, flashTimer=0, flashType='';
function flash(type){flashType=type; flashTimer=18;}
function draw(){
  t+=1/60; applyDecay(); setMood(); refreshBars();

  // h√°tt√©r
  const grad=ctx.createLinearGradient(0,0,0,cvs.height);
  grad.addColorStop(0,'#bfe3ff'); grad.addColorStop(1,'#ffffff');
  ctx.fillStyle=grad; ctx.fillRect(0,0,cvs.width,cvs.height);
  // padl√≥
  ctx.fillStyle='#e2e8f0'; ctx.fillRect(0,cvs.height-90,cvs.width,90);
  // felh≈ëk
  ctx.fillStyle='rgba(255,255,255,.9)';
  for(let i=0;i<4;i++){ const x=(t*30 + i*220)% (cvs.width+200)-100, y=60+20*(i%2);
    bubble(x,y,22); bubble(x+18,y-8,16); bubble(x+38,y,20);
  }

  // pet
  const cx=cvs.width/2, cy=cvs.height-140, base=70, bob= Math.sin(t*2)*4;
  const color= pet.mood==='happy' ? '#8bffb3' : pet.mood==='sad' ? '#ffd1d1' : pet.mood==='sleepy' ? '#fff2b3' : '#ffeaa7';
  ctx.fillStyle=color; round(cx- base, cy- base + bob, base*2, base*2, base);
  ctx.fill();

  // szemek + sz√°j
  const eyeOff = pet.mood==='sleepy' ? 0.2 : 1;
  ctx.fillStyle='#fff'; round(cx-22, cy-8+bob, 22,22*eyeOff, 11); ctx.fill();
  round(cx+ 2, cy-8+bob, 22,22*eyeOff, 11); ctx.fill();
  ctx.fillStyle='#111'; round(cx-12, cy-2+bob, 8,8*eyeOff, 4); ctx.fill();
  round(cx+12-8, cy-2+bob, 8,8*eyeOff, 4); ctx.fill();
  ctx.strokeStyle='#111'; ctx.lineWidth=3; ctx.beginPath();
  if(pet.mood==='happy'){ arcSmile(cx, cy+18+bob, 16, 0.6); }
  else if(pet.mood==='sad'){ arcSad(cx, cy+24+bob, 16, 0.6); }
  else { ctx.moveTo(cx-10, cy+22+bob); ctx.lineTo(cx+10, cy+22+bob); }
  ctx.stroke();

  // akci√≥ flash
  if(flashTimer>0){ flashTimer--; const alpha=flashTimer/18;
    const col = flashType==='feed'?'#a7f3d0':flashType==='wash'?'#bae6fd':flashType==='sleep'?'#fde68a':'#fecaca';
    ctx.fillStyle=col; ctx.globalAlpha=0.35*alpha; round(cx-95,cy-110,190,140,20); ctx.fill(); ctx.globalAlpha=1;
  }

  requestAnimationFrame(draw);
}
function round(x,y,w,h,r){ const rr=Math.min(r,Math.abs(w)/2,Math.abs(h)/2); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath(); }
function bubble(x,y,r){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }
function arcSmile(cx,cy,r,k){ ctx.arc(cx,cy,r,Math.PI*(1-k),Math.PI*(0+k)); }
function arcSad(cx,cy,r,k){ ctx.arc(cx,cy,r,Math.PI*(0+k),Math.PI*(1-k),true); }

draw();

/* ======= Chat ======= */
const logEl = $('log'), input=$('input'), send=$('send');
function push(role,text){ const div=document.createElement('div'); div.className='msg '+role; const b=document.createElement('div'); b.className='bubble'; b.textContent=text; div.appendChild(b); logEl.appendChild(div); logEl.scrollTop=logEl.scrollHeight; }
send.onclick=async ()=>{
  const text=input.value.trim(); if(!text) return;
  push('me', text); input.value=''; beep(700,.05,'triangle',.05);

  // R√ñVID kontextus a backendre
  const sys = `Te egy kedves, j√°t√©kos kis virtu√°lis h√°zi√°llat vagy, a neved ${pet.name}.
√Ållapotaid: √©hs√©g=${pet.hunger|0}/100, energia=${pet.energy|0}, tisztas√°g=${pet.clean|0}, boldogs√°g=${pet.happy|0}.
V√°laszolj r√∂viden (1-2 mondat), kedves hangon, emojikkal.`;

  try{
    const res = await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({system:sys,user:text})});
    if(!res.ok) throw new Error('chat hiba');
    const data = await res.json();
    push('ai', data.reply || '(nincs v√°lasz)');
  }catch(e){
    push('ai','Hopp, nem √©rem el a chat szervert. üòø (Be van √°ll√≠tva a proxy?)');
  }
};
input.addEventListener('keydown',e=>{if(e.key==='Enter') send.click();});

// els≈ë interakci√≥n√°l ind√≠tsd az audiot
addEventListener('pointerdown',()=>{ if(AC && AC.state==='suspended') AC.resume(); }, {once:true});
</script>
</body>
</html>
